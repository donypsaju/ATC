<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWD Reservation Dashboard: Kerala Aided Schools</title>
    
    <!-- --- GOOGLE ANALYTICS START --- -->
    <!-- Replace 'G-XXXXXXXXXX' with your actual Measurement ID -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-XXXXXXXXXX');
    </script>
    <!-- --- GOOGLE ANALYTICS END --- -->

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Custom CSS -->
    <style>
        .chart-container { position: relative; height: 350px; width: 100%; }
        .chart-container-donut { position: relative; height: 350px; width: 100%; max-width: 350px; margin: 0 auto; }
        .btn-group-xs .btn { padding: .25rem .5rem; font-size: .875rem; }
        .calc-info { cursor: help; border-bottom: 1px dotted rgba(255,255,255,0.5); }
        
        /* Card visual improvements */
        .card { border: 1px solid rgba(255,255,255,0.1); background-color: #212529; }
        .kpi-value { font-weight: 700; letter-spacing: -1px; }
        .text-white-50 { color: rgba(255, 255, 255, 0.5) !important; }
        
        /* Auditor Table Styling */
        .table-auditor th { font-size: 0.8rem; vertical-align: middle; text-align: center; background-color: #343a40; color: #fff; }
        .table-auditor td { font-size: 0.9rem; text-align: center; vertical-align: middle; }
        .table-auditor td:first-child { text-align: left; font-weight: bold; }
        .bg-subtle-success { background-color: rgba(25, 135, 84, 0.2); }
        .bg-subtle-danger { background-color: rgba(220, 53, 69, 0.2); }
    </style>
</head>
<body class="bg-dark text-white">

    <!-- 1. HEADER (Minimal) -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary sticky-top px-3">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold text-warning" href="#">
                <i class="bi bi-bar-chart-line-fill me-2"></i>PWD Reservation Dashboard
            </a>
        </div>
    </nav>

    <!-- 2. SEARCH RESULTS (Only triggered by Auditor Search now) -->
    <div class="container-fluid mb-4 mt-3" id="search-results-row" style="display: none;">
        <!-- Container preserved for future expansion if needed -->
    </div>

    <!-- 3. MAIN DASHBOARD -->
    <div class="container-fluid my-3">
        
        <!-- ROW 1: Filters & Actions (Consolidated) -->
        <div class="row g-3 mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-body d-flex flex-column flex-lg-row gap-3 justify-content-between align-items-lg-center">
                        
                        <!-- Left: Filters -->
                        <div class="d-flex flex-wrap gap-3 align-items-center">
                            <div class="filter-group">
                                <div class="text-white-50 small mb-1 fw-bold"><i class="bi bi-funnel me-1"></i>Filter Data By</div>
                                <div class="btn-group" role="group" id="filter-main">
                                    <button type="button" class="btn btn-outline-primary active" data-filter="All">All Posts</button>
                                    <button type="button" class="btn btn-outline-primary" data-filter="Teaching">Teaching</button>
                                    <button type="button" class="btn btn-outline-primary" data-filter="NonTeaching">Non-Teaching</button>
                                </div>
                            </div>
                            <div class="filter-group" id="sub-filter-container" style="display: none;">
                                <div class="text-white-50 small mb-1 fw-bold">Teaching Category</div>
                                <div class="btn-group btn-group-xs flex-wrap" role="group" id="filter-sub">
                                    <button type="button" class="btn btn-outline-secondary active" data-filter="All">All Teaching</button>
                                    <button type="button" class="btn btn-outline-secondary" data-filter="Primary">Primary (LP+UP)</button>
                                    <button type="button" class="btn btn-outline-secondary" data-filter="LPST">LPST</button>
                                    <button type="button" class="btn btn-outline-secondary" data-filter="UPST">UPST</button>
                                    <button type="button" class="btn btn-outline-secondary" data-filter="HST">HST</button>
                                    <button type="button" class="btn btn-outline-secondary" data-filter="HSST">HSST</button>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Actions & Dates -->
                        <div class="d-flex flex-column align-items-lg-end gap-2">
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#projectInfoModal">
                                    <i class="bi bi-info-circle"></i> About
                                </button>
                                <a href="https://forms.gle/S8yEWBqR2XWNdtBj9" target="_blank" class="btn btn-sm btn-outline-success">
                                    <i class="bi bi-plus-circle"></i> Contribute
                                </a>
                            </div>
                            <div class="text-white-50 small text-lg-end">
                                <div id="roster-update-time">Roster: Loading...</div>
                                <div id="candidate-update-time">Candidates: Loading...</div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Key Findings -->
        <div class="row g-3 mb-3">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-body">
                        <h5 class="card-title text-warning"><i class="bi bi-lightbulb-fill me-2"></i>Key Findings</h5>
                        <ul class="fs-5 mb-0 text-white" id="key-findings-list">
                            <li id="finding-1">Calculating...</li>
                            <li id="finding-2">Calculating...</li>
                            <li id="finding-3">Calculating...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="row g-3 mb-3">
            <!-- Row 1 -->
            <div class="col-lg-3 col-md-6">
                <div class="card h-100 border-danger" style="background: linear-gradient(45deg, #4a1010, #212529);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div class="text-danger small fw-bold">TOTAL OBLIGATION (DEMAND)</div>
                            <i class="bi bi-question-circle text-white-50" data-bs-toggle="tooltip" title="Posts legally reserved for PWD. Calculated as 3% of appointments before 2017 + 4% after 2017."></i>
                        </div>
                        <div class="fs-1 fw-bold text-white mt-2" id="kpi-total-owed">--</div>
                        <div class="small text-white-50 mt-1">Total posts mandated by PWD Act</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card h-100 border-primary" style="background: linear-gradient(45deg, #0d2b4a, #212529);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div class="text-primary small fw-bold">AVAILABLE CANDIDATES (SUPPLY)</div>
                            <i class="bi bi-question-circle text-white-50" data-bs-toggle="tooltip" title="Total candidates registered in Employment Exchanges across Kerala (Data source: RTI)."></i>
                        </div>
                        <div class="fs-1 fw-bold text-white mt-2" id="kpi-total-supply">--</div>
                        <div class="small text-white-50 mt-1" id="kpi-supply-detail">Includes both Teaching & Non-Teaching</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card h-100 border-warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div class="text-warning small fw-bold">POSTS IN LIMBO</div>
                            <i class="bi bi-exclamation-triangle text-white-50" data-bs-toggle="tooltip" title="Appointments that are stalled. Either the management hasn't appointed anyone (Vacant) or the Govt hasn't approved the appointment (Not Approved)."></i>
                        </div>
                        <div class="fs-1 fw-bold text-white mt-2" id="kpi-total-limbo">--</div>
                        <div class="small text-white-50 mt-1">Sum of Vacant + Not Approved</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card h-100 border-success" style="background: linear-gradient(45deg, #0f3d20, #212529);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div class="text-success small fw-bold">SUCCESSFULLY FILLED</div>
                            <i class="bi bi-check-circle text-white-50" data-bs-toggle="tooltip" title="Posts where a PWD candidate has been appointed by management."></i>
                        </div>
                        <div class="fs-1 fw-bold text-white mt-2" id="kpi-total-filled">--</div>
                        <div class="small text-white-50 mt-1">Direct appointments by Management</div>
                    </div>
                </div>
            </div>

            <!-- Row 2 -->
            <div class="col-lg-3 col-md-6">
                <div class="card h-100 border-info">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div class="text-info small fw-bold">REPORTED TO GOVT</div>
                            <i class="bi bi-arrow-up-right-circle text-white-50" data-bs-toggle="tooltip" title="Vacancies reported to the Employment Exchange for recruitment."></i>
                        </div>
                        <div class="fs-1 fw-bold text-white mt-2" id="kpi-total-reported">--</div>
                        <div class="small text-white-50 mt-1">In recruitment pipeline</div>
            <!-- UPDATED CARD: Non-Compliant Managements (Split View) -->
            <div class="col-lg-3 col-md-6">
                <div class="card h-100 border-secondary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="text-secondary small fw-bold">ROSTER COMPLIANCE</div>
                            <i class="bi bi-clipboard-check text-white-50" data-bs-toggle="tooltip" title="Comparison of total managements vs those who have not submitted any roster data (Zero appointments)."></i>
                        </div>
                        
                        <div class="row g-0 text-center">
                            <!-- Section 1: Total Managements -->
                            <div class="col-6 border-end border-secondary pe-2">
                                <div class="fs-2 fw-bold text-white" id="kpi-total-managements">--</div>
                                <div class="small text-white-50" style="font-size: 0.75rem;">Total Tracked</div>
                            </div>
                            
                            <!-- Section 2: Non-Compliant -->
                            <div class="col-6 ps-2">
                                <div class="fs-2 fw-bold text-warning" id="kpi-non-compliant">--</div>
                                <div class="small text-white-50" style="font-size: 0.75rem;">Not Submitted</div>
                            </div>
                        </div>

                        <div class="d-grid mt-3">
                            <button class="btn btn-sm btn-outline-secondary py-1" data-bs-toggle="modal" data-bs-target="#nonCompliantModal">View Non-Compliant List</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RESTORED CARD: RTI Entries -->
            <div class="col-lg-3 col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-secondary small fw-bold">DATA SOURCES (RTI)</div>
                        <div class="fs-1 fw-bold text-white mt-2" id="kpi-rti-entries">--</div>
                        <div class="small text-white-50 mt-1">Employment Exchanges Data</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row g-3">
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title text-white-50">Supply vs. Demand (Gap Analysis)</h5>
                        <div class="chart-container">
                            <canvas id="supplyDemandChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title text-white-50">Action on Owed Posts</h5>
                        <div class="chart-container-donut">
                            <canvas id="actionOnOwedChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title text-white-50">Candidates by Disability</h5>
                        <div class="chart-container-donut">
                            <canvas id="candidateDisabilityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title text-white-50">Candidates by Post</h5>
                        <div class="chart-container">
                            <canvas id="candidatePostChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-12">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title text-white-50">Roster Verification Status</h5>
                        <div class="chart-container-donut">
                            <canvas id="verificationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. Detailed Auditor Section -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card border-secondary">
                    <div class="card-header bg-dark border-secondary">
                        <h4 class="mb-0 text-white"><i class="bi bi-table me-2"></i>Detailed Management Auditor</h4>
                        <p class="text-white-50 small mb-0">Use this tool to generate the official Roster Data table for any specific management.</p>
                    </div>
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <span class="input-group-text bg-secondary border-secondary text-white"><i class="bi bi-search"></i></span>
                            <input class="form-control bg-dark text-white border-secondary" type="text" id="auditor-search" list="auditor-search-list" placeholder="Search Management to Audit...">
                            
                            <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('auditor-search').value = ''; handleAuditorSearch({ target: { value: '' } });">
                                <i class="bi bi-x-lg"></i> Clear
                            </button>
                            
                            <datalist id="auditor-search-list"></datalist>
                        </div>

                        <div class="collapse" id="auditorTableCollapse">
                            <h5 id="auditor-mgmt-name" class="text-warning mb-3"></h5>
                            <div class="table-responsive">
                                <table class="table table-dark table-bordered table-auditor table-hover align-middle">
                                    <thead>
                                        <tr>
                                            <th rowspan="2">Category</th>
                                            <th colspan="2">Pre-2017 Appointments</th>
                                            <th colspan="2">Post-2017 Appointments</th>
                                            <th rowspan="2">Total Reserved<br>(Net Owed)</th>
                                            <th rowspan="2">Filled by<br>Mgmt</th>
                                            <th rowspan="2">Reservation<br>Balance</th>
                                            <th rowspan="2">Not Approved</th>
                                            <th rowspan="2">Vacant</th>
                                            <th rowspan="2">Total Limbo<br>(Not Appr + Vacant)</th>
                                            <th rowspan="2">Reported to<br>Exchange</th>
                                            <th rowspan="2">Current Backlog<br>(Pending Action)</th>
                                        </tr>
                                        <tr>
                                            <th>Count</th>
                                            <th>3%</th>
                                            <th>Count</th>
                                            <th>4%</th>
                                        </tr>
                                    </thead>
                                    <tbody id="auditor-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- 4. FOOTER -->
    <footer class="text-center mt-5 py-4 text-white-50 border-top border-secondary">
        <div class="container">
            <p class="mb-1">Data sourced from <strong>Samanwaya Portal (Public Roster)</strong> and <strong>RTI Applications</strong>.</p>
            <small class="d-block mb-2">&copy; 2025 PWD Reservation Dashboard.</small>
            
            <!-- VISITOR COUNTER -->
            <small class="badge bg-secondary bg-opacity-25 border border-secondary text-white-50">
                <i class="bi bi-eye me-1"></i> Visitors: <span class="visitor-count-display">...</span>
            </small>
        </div>
    </footer>

    <!-- 5. ABOUT & DATA GUIDE MODAL -->
    <div class="modal fade" id="projectInfoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-warning"><i class="bi bi-info-circle-fill me-2"></i>About This Project</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>This dashboard is a volunteer initiative to bring transparency to the implementation of the PWD Reservation Act in Kerala's aided schools. Our goal is to highlight the gap between legal obligations and the current reality.</p>
                    
                    <div class="d-flex justify-content-between align-items-center bg-secondary bg-opacity-10 border border-secondary rounded p-2 mb-3">
                        <span class="text-white-50 small">Total Dashboard Visits</span>
                        <span class="badge bg-info text-dark visitor-count-display">...</span>
                    </div>

                    <div class="alert alert-info bg-opacity-10 border-info text-white">
                        <strong><i class="bi bi-exclamation-circle-fill"></i> Data Limitations & Authenticity</strong><br>
                        <ul>
                            <li><strong>Roster Data (Demand):</strong> Scraped from the public <a href="https://samanwaya.kite.kerala.gov.in" target="_blank" class="text-info">Samanwaya Portal</a>. It represents the official government data as currently verified.</li>
                            <li><strong>Candidate Data (Supply):</strong> Sourced from RTI (Right to Information) replies from various Employment Exchanges.</li>
                            <li><strong>Work in Progress:</strong> This data is not yet exhaustive. RTI data is manually entered, and Roster data is updated weekly. We rely on the community to help us fill the gaps.</li>
                        </ul>
                    </div>

                    <h6 class="text-warning mt-4"><i class="bi bi-lightbulb-fill"></i> Interpreting the Data</h6>
                    <div class="p-3 bg-secondary bg-opacity-25 rounded border border-secondary mb-3">
                        <strong>The "Surplus" Illusion:</strong><br>
                        A high number of "Available Candidates" often includes thousands of Non-Teaching applicants (Peons, Sweepers). <br>
                        <em>Always use the <strong>"Teaching"</strong> filter to see the true shortage of qualified teachers vs. posts owed.</em>
                    </div>

                    <h6>Key Definitions:</h6>
                    <ul class="small text-white-50">
                        <li><strong>Owed (Demand):</strong> Statutory requirement (3% of pre-2017 + 4% of post-2017 appointments).</li>
                        <li><strong>Limbo:</strong> Posts that are either vacant or not approved by the government.</li>
                        <li><strong>Unaccounted:</strong> Owed posts that have not been filled AND not been reported to the Exchange.</li>
                    </ul>
                    
                    <hr class="border-secondary">
                    <p class="mb-0 text-center">
                        Found an error? Have new RTI data? <br>
                        <a href="https://forms.gle/S8yEWBqR2XWNdtBj9" target="_blank" class="btn btn-success mt-2"><i class="bi bi-pencil-square"></i> Submit Correction / New Data</a>
                    </p>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. NEW MODAL: Non-Compliant Managements -->
    <div class="modal fade" id="nonCompliantModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-secondary"><i class="bi bi-clipboard-x me-2"></i>Roster Not Submitted</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" id="nc-search" class="form-control bg-dark text-white border-secondary" placeholder="Search in this list...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark table-striped table-hover table-sm">
                            <thead class="sticky-top">
                                <tr>
                                    <th>Management Name</th>
                                    <th>Schools Verified</th>
                                    <th>Total Schools</th>
                                </tr>
                            </thead>
                            <tbody id="nc-table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="config.js"></script>
    <script src="app.js"></script>
</body>
</html>